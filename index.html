<html>
<head>
    <meta charset="utf-8" />
    <title>Dreamland Painter</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>


<body style="margin: 0; background-color:black">
    <div id="button_container" style="right:0%; top:1%; position:fixed; display:block; width:10%; z-index:1;">
        <button class="button" id="white_button">white</button>
        <button class="button" id="eyedropper_button">eyedropper</button>
        <button class="button" id="increase_brush_size_button">+</button>
        <button class="button" id="decrease_brush_size_button">-</button>
        <button class="button" id="color_panel">color</button>
        <button class="button" id="pen">pen</button>
    </div>
    <div id="footer" style="left:1%; bottom:1%; position:fixed; width:50%; z-index:1;">
        <div class="slidecontainer"><input type="range" min="0" max="255" value="50" class="slider" id="hue_slider"></div>
        <div class="slidecontainer"><input type="range" min="0" max="255" value="50" class="slider" id="saturation_slider"></div>
        <div class="slidecontainer"><input type="range" min="0" max="255" value="50" class="slider" id="value_slider"></div>
    </div>
    <br>
</body>
</html>

<script>
print = console.log

var canvas = document.createElement('canvas');
canvas.id = 'someId';
// canvas.width = 1080*.88;
// canvas.height = 1920*.88;
canvas.width = 1080;
canvas.height = 1920;
canvas.width = 1920;
canvas.height = 1080;
canvas.style.position = 'absolute';
canvas.style.left = '1%';

if (canvas.height > canvas.width) {
    canvas.style.height = '88%';
    canvas.style.width = canvas.style.height * 9/16;
}
else {
    canvas.style.width = '88%';
    canvas.style.height = canvas.style.width * 9/16;
}
document.body.appendChild(canvas);

ctx = canvas.getContext('2d')
ctx.fillStyle = 'white';
ctx.fillRect(0, 0, canvas.width, canvas.height);

img = new Image();
img.src = "pokebrush.png";

cvs_size = 128;
var cvs = document.createElement('canvas');
cvs.width = cvs_size;
cvs.height = cvs_size;
var ctx2 = cvs.getContext("2d");
ctx.drawImage(img, 0, 0, cvs_size, cvs_size);
var imgData = ctx2.getImageData(0, 0, cvs_size, cvs_size);
var i;
for (i = 0; i < imgData.data.length; i += 4) {
  // print(imgData.data[i+3]);
  imgData.data[i] = 255;
  imgData.data[i+1] = 100;
  imgData.data[i+2] = 0;
  imgData.data[i+3] = 255;
}

ctx2.putImageData(imgData, 0, 0);
// document.body.appendChild(cvs);
// img.src = cvs.toDataURL();
// img.data = imgData;
color = [128, 128, 0];
drawing = false;
var prev_pos = null;

function mouse_down(ev) {
    // color = [128, 128, 0];
    // color = [Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)];
    // tint the brush
    var cvs = document.createElement('canvas');
    cvs.width = cvs_size;
    cvs.height = cvs_size;
    var ctx2 = cvs.getContext("2d");
    ctx2.drawImage(img, 0, 0, cvs_size, cvs_size);
    var imgData = ctx2.getImageData(0, 0, cvs_size, cvs_size);
    var i;
    for (i = 0; i < imgData.data.length; i += 4) {
      imgData.data[i] = color[0];
      imgData.data[i+1] = color[1];
      imgData.data[i+2] = color[2];
      imgData.data[i+3] = imgData.data[i+3];
    }

    ctx2.putImageData(imgData, 0, 0);
    img.src = cvs.toDataURL();

    drawing = true;
    paint(ev);
    // ctx.fillStyle = 'teal';

    // var imageData = ctx.getImageData(ev.x, ev.y, 1, 1).data;
    // rgbaColor = 'rgba(' + imageData[0] + ',' + imageData[1] + ',' + imageData[2] + ',1)';
    // print('color:', rgbaColor);
    // if (rgbaColor != 'rgba(0,0,0,1)') {
    //     ctx.fillStyle = rgbaColor;
    // }
    // ctx.fillRect(ev.x, ev.y, 64, 64);
    // ctx.drawImage(img, ev.x, ev.y, 64, 64);
}
canvas.addEventListener("mousedown", mouse_down, false);
canvas.addEventListener("touchstart", mouse_down, false);

function mouse_up(ev) {
    drawing = false;
    prev_pos = null;
}
document.addEventListener("mouseup", mouse_up, false);
document.addEventListener("touchend", mouse_up, false);
var canvas_rect = canvas.getBoundingClientRect();
var brush_size = 256;

function distanceApprox(p1,p2){
	// Approximation by using octagons approach
	var x = p2[0]-p1[0];
	var y = p2[1]-p1[1];
	return 1.426776695*Math.min(0.7071067812*(Math.abs(x)+Math.abs(y)), Math.max (Math.abs(x), Math.abs(y)));
}

function lerp(a, b, t) {
    return a + (b - a) * t;
}

function paint(e) {
    if (drawing) {
        if(e.type == 'touchmove') {
            e.preventDefault();
            var touch = e.touches[0] || e.changedTouches[0];
            var h = canvas.height / canvas_rect.height;
            x = (touch.pageX - canvas_rect.x) * h;
            y = (touch.pageY - canvas_rect.top) * h;
        }
        else {
            var h = canvas.height / canvas_rect.height;
            x = (e.x - canvas_rect.x) * h;
            y = (e.y - canvas_rect.top) * h;
        }
        if (prev_pos == null) {
            ctx.drawImage(img, x-(brush_size/2), y-(brush_size/2), brush_size, brush_size);
        }
        else {
            var dist = distanceApprox(prev_pos, [x,y]);
            dist = Math.floor(dist);

            if (dist <= 1 * (brush_size/16)) {
                ctx.drawImage(img, x-(brush_size/2), y-(brush_size/2), brush_size, brush_size);
            }
            else {  // draw line between points
                for (var i = 0; i < dist; i++) {
                    t = i/dist;
                    var _x = lerp(prev_pos[0], x, t);
                    var _y = lerp(prev_pos[1], y, t);
                    ctx.drawImage(img, _x-(brush_size/2), _y-(brush_size/2), brush_size, brush_size);
                }
            }
        }
        prev_pos = [x,y];
    }
}
canvas.addEventListener("mousemove", paint, false);
canvas.addEventListener("touchmove", paint, false);


// color sliders
var white_button = document.getElementById("white_button");
var hue_slider = document.getElementById("hue_slider");
var saturation_slider = document.getElementById("saturation_slider");
var value_slider = document.getElementById("value_slider");
var color_panel = document.getElementById("color_panel");

white_button.onclick = function() {color=[255,255,255,255]}

document.getElementById("eyedropper_button").onclick = function() {
    color=[255,255,255,255]
}
document.getElementById("increase_brush_size_button").onclick = function() {brush_size *= 1.5}
document.getElementById("decrease_brush_size_button").onclick = function() {brush_size *= .75}

function update_color () {
  color_panel.style.backgroundColor = 'rgb('+hue_slider.value+', '+saturation_slider.value+', '+value_slider.value+')';
  color = [hue_slider.value, saturation_slider.value, value_slider.value];
}

hue_slider.oninput = update_color
saturation_slider.oninput = update_color
value_slider.oninput = update_color

</script>
